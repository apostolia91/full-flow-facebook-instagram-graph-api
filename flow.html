<!DOCTYPE html>
<html>
  <head>
    <title>
      Test Your facebook login, grab your facebook linked page and then grab the
      instagram information
    </title>
    <style>
      .even {
        background: brown;
        color: white;
      }
      .odd {
        background: saddlebrown;
        color: white;
      }
    </style>
  </head>
  <body>
    <h2>Objective:</h2>
    <h4>
      Test Your facebook login, grab your facebook linked page and then grab the
      instagram information
    </h4>
    <h3>Step1: facbeook login</h3>
    <fb:login-button scope="public_profile,email" onlogin="doLogin();">
    </fb:login-button>

    <h3 class="">Step2 : Get app token</h3>
    <pre class="even" id="contentBody0"></pre>
    <h3 class="">Step 3: Get Response fb login</h3>
    <pre class="odd" id="contentBody"></pre>
    <h3 class="">Step 4: Get Response fb login profile</h3>
    <pre class="even" id="contentBody5"></pre>
    <h3 class="">Step 5: Get Response fb-page instabusiness account</h3>
    <pre class="odd" id="contentBody6"></pre>
    <h3 class="">Step 6: Get Response instabusiness profile account</h3>
    <pre class="even" id="contentBody7"></pre>

    <h3 class="">Step 6: Get Response instabusiness profile insights</h3>
    <pre class="odd" id="contentBody8"></pre>

    <h3 class="">Step 7: Get Response instabusiness posts</h3>
    <pre class="even" id="contentBody9"></pre>
    <script>
      const appId = "your-app-id";
      const clientToken = "your-client-token";
      let globalAppToken = "";

      function getAppToken(instaUserId, accessToken) {
        const url = `https://graph.facebook.com/oauth/access_token?client_id=${appId}&client_secret=${clientToken}&grant_type=client_credentials`;
        let headers = new Headers();
        headers.append("Accept", "application/json");

        fetch(url, {
          mode: "cors",
          method: "GET",
          headers: headers,
        })
          .then((response) => response.json())
          .then((json) => {
            document.getElementById("contentBody0").innerHTML = JSON.stringify(
              json,
              null,
              "\n\t"
            );
            globalAppToken = json.access_token;
            getMyfbAcc(instaUserId, accessToken);
            console.log(json);
            return json;
          })
          .catch((error) =>
            console.log("Authorization failed : " + error.message)
          );
      }

      function getMyInstagramAccMediaStats(instaUserId, accessToken) {
        const url = `https://graph.facebook.com/v8.0/${instaUserId}/media?fields=shortcode,caption,comments_count,thumbnail_url,username,media_type,media_url,like_count,comments,is_comment_enabled&limit=10&access_token=${accessToken}`;

        let headers = new Headers();

        headers.append("Accept", "application/json");

        fetch(url, {
          mode: "cors",
          method: "GET",
          headers: headers,
        })
          .then((response) => response.json())
          .then((json) => {
            document.getElementById("contentBody9").innerHTML = JSON.stringify(
              json,
              null,
              "\n\t"
            );
            console.log(json);
            return json;
          })
          .catch((error) =>
            console.log("Authorization failed : " + error.message)
          );
      }

      function getMyInstagramAccInsight(instaUserId, accessToken) {
        const url = `https://graph.facebook.com/v8.0/${instaUserId}/insights?metric=impressions,reach,profile_views&period=day&access_token=${accessToken}`;

        let headers = new Headers();

        headers.append("Accept", "application/json");

        fetch(url, {
          mode: "cors",
          method: "GET",
          headers: headers,
        })
          .then((response) => response.json())
          .then((json) => {
            document.getElementById("contentBody8").innerHTML = JSON.stringify(
              json,
              null,
              "\n\t"
            );
            console.log(json);
            getMyInstagramAccMediaStats(instaUserId, accessToken);
            return json;
          })
          .catch((error) =>
            console.log("Authorization failed : " + error.message)
          );
      }

      function getMyInstagramAccInfo(instaUserId, accessToken) {
        const url = `https://graph.facebook.com/v8.0/${instaUserId}?fields=biography,followers_count,follows_count,ig_id,name,profile_picture_url&access_token=${accessToken}`;

        let headers = new Headers();

        headers.append("Accept", "application/json");

        fetch(url, {
          mode: "cors",
          method: "GET",
          headers: headers,
        })
          .then((response) => response.json())
          .then((json) => {
            document.getElementById("contentBody7").innerHTML = JSON.stringify(
              json,
              null,
              "\n\t"
            );
            console.log(json);
            getMyInstagramAccInsight(instaUserId, accessToken);
            return json;
          })
          .catch((error) =>
            console.log("Authorization failed : " + error.message)
          );
      }
      function getMyFbInstaBusinessAcc(instaUserId, accessToken) {
        const url = `https://graph.facebook.com/v8.0/${instaUserId}?fields=instagram_business_account&access_token=${accessToken}`;

        let headers = new Headers();

        headers.append("Accept", "application/json");

        fetch(url, {
          mode: "cors",
          method: "GET",
          headers: headers,
        })
          .then((response) => response.json())
          .then((json) => {
            document.getElementById("contentBody6").innerHTML = JSON.stringify(
              json,
              null,
              "\n\t"
            );
            console.log(json);
            if (
              json.instagram_business_account &&
              json.instagram_business_account.id
            ) {
              getMyInstagramAccInfo(
                json.instagram_business_account.id,
                accessToken
              );
            }
            return json;
          })
          .catch((error) =>
            console.log("Authorization failed : " + error.message)
          );
      }

      function getMyfbAcc(instaUserId, accessToken) {
        const wantedFields = "id,username,media_count";
        const url = `https://graph.facebook.com/v8.0/me/accounts?access_token=${accessToken}`;
        // me/accounts?fields=app_id,id,name,page_token,affiliation
        let headers = new Headers();

        headers.append("Accept", "application/json");

        fetch(url, {
          mode: "cors",
          method: "GET",
          headers: headers,
        })
          .then((response) => response.json())
          .then((json) => {
            document.getElementById("contentBody5").innerHTML = JSON.stringify(
              json,
              null,
              "\n\t"
            );
            console.log(json);
            if (json && json.data && json.data.length) {
              getMyFbInstaBusinessAcc(
                json.data[0].id,
                json.data[0].access_token
              );
            }
            return json;
          })
          .catch((error) =>
            console.log("Authorization failed : " + error.message)
          );
      }

      function getMyInsight(instaUserId, accessToken) {
        const wantedFields = "id,username,media_count";
        const url = `https://graph.facebook.com/v8.0/${instaUserId}?fields=business_discovery.username(bluebottle){followers_count,media_count}&access_token=${accessToken}`;

        let headers = new Headers();
 
        headers.append("Accept", "application/json"); 

        fetch(url, {
          mode: "cors",
          method: "GET",
          headers: headers,
        })
          .then((response) => response.json())
          .then((json) => {
            document.getElementById("contentBody6").innerHTML = JSON.stringify(
              json,
              null,
              "\n\t"
            );
            console.log(json);
            return json;
          })
          .catch((error) =>
            console.log("Authorization failed : " + error.message)
          );
      }

      function getInstgramProfile(instagramProfileId) {
        FB.api(`${instagramProfileId}`, function (responseData) {
          console.log("getInstgramProfile", responseData);
          if (responseData && !responseData.error) {
            document.getElementById("contentBody4").innerHTML = JSON.stringify(
              responseData,
              null,
              "\n\t"
            );
          }
        });
      }
      function getMyInfo() {
        // me?fields=id,name,about,gender,email,work,short_name,interested_in,middle_name,website
        FB.api("/me", function (responseData) {
          console.log("getMyInfo", responseData);
          const instaUserId = responseData.id;
          //   getInstgramProfile("31148797299");
          getInstgramProfile(responseData.id);
          document.getElementById("contentBody2").innerHTML = JSON.stringify(
            responseData,
            null,
            "\n\t"
          );
        });
      }
      function doLoginSuccess(responseData) {
        const instaUserId = responseData.authResponse.userID;
        const accessToken = responseData.authResponse.accessToken;
        getAppToken(instaUserId, accessToken);
        // getMyfbAcc(instaUserId, accessToken);
        document.getElementById("contentBody").innerHTML = JSON.stringify(
          responseData,
          null,
          "\n\t"
        );
        // getMyInfo();
      }
      function checkLoginState() {
        FB.getLoginStatus(function (response) {
          if (response.status === "connected") {
          }
        });
      }
      function doLogin() {
        FB.login(
          function (response) {
            if (response.status === "connected") {
              // Logged into your webpage and Facebook.
              doLoginSuccess(response);
              console.log(response.authResponse.accessToken);
            }
            console.log(response);
          },
          { scope: "email,public_profile,pages_show_list" }
        );
      }

      // initalize ------------------->
      window.fbAsyncInit = function () {
        FB.init({
          appId: "1149917375378502",
          cookie: true,
          xfbml: true,
          version: "v8.0",
        });

        FB.AppEvents.logPageView();
      };

      (function (d, s, id) {
        var js,
          fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {
          return;
        }
        js = d.createElement(s);
        js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      })(document, "script", "facebook-jssdk");
      // <------------------- initalize
    </script>
  </body>
</html>
